<html>
  <body>
    <p>Hello</p>

    <input type="file" id="romInput" onchange="openRomAndStart(event)">

    <canvas width="640" height="480" id="webrioCanvas"></canvas>

    <script type="module">
     import { Renderer } from "./renderer.js";
     import webrioLoader from "./webrio.js";

     (async function() {
       const Webrio = await webrioLoader();

       window.openRomAndStart = async e => {
         const buf = await e.target.files[0].arrayBuffer();
         const rom = new Uint8Array(buf);

         const heapRomPtr = Webrio._malloc(rom.length);
         const heapRom = new Uint8Array(Webrio.HEAPU8.buffer, heapRomPtr, rom.length);
         heapRom.set(rom);

         const heapTexLength = Webrio.ccall('webrio_get_sm64_texture_length',
                                            'number', [], []);
         const heapTexPtr = Webrio._malloc(heapTexLength);

         Webrio._webrio_init(heapRomPtr, heapTexPtr);

         const renderer = new Renderer(webrioCanvas);
         window.requestAnimationFrame(function tick() {
           Webrio._webrio_tick();

           renderer.draw();

           window.requestAnimationFrame(tick);
         });
       };
       
       console.log("Hello!");
     })();
    </script>
  </body>
</html>
